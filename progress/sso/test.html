<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SSO + MFA Test</title>
  <style>
    body { font-family: sans-serif; background: #f5f5f5; }
    .container { max-width: 480px; margin: 40px auto; background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    h1 { font-size: 22px; margin-bottom: 8px; }
    h2 { font-size: 18px; margin-top: 24px; margin-bottom: 8px; }
    label { display: block; margin-bottom: 4px; font-weight: 600; }
    input[type="text"], input[type="email"], input[type="password"], input[type="number"] {
      width: 100%; padding: 8px 10px; margin-bottom: 10px; box-sizing: border-box;
      border-radius: 4px; border: 1px solid #ccc;
    }
    button { padding: 8px 14px; border-radius: 4px; border: none; cursor: pointer; }
    .btn-primary { background: #1976d2; color: #fff; }
    .btn-secondary { background: #555; color: #fff; }
    .btn-block { width: 100%; margin-top: 8px; }
    .row { display: flex; gap: 8px; }
    .row > div { flex: 1; }
    .status { margin-top: 12px; font-size: 13px; }
    .status.ok { color: #2e7d32; }
    .status.error { color: #c62828; }
    .token-box { margin-top: 12px; font-size: 11px; word-break: break-all; background: #f0f0f0; padding: 8px; border-radius: 4px; max-height: 150px; overflow:auto; }
    .qr { margin-top: 10px; text-align: center; }
    .qr img { border: 1px solid #ccc; padding: 4px; background: #fff; }
    small { color: #666; }
  </style>
</head>
<body>
<div class="container">
  <h1>SSO + MFA Test UI</h1>
  <p><small>Use this page to manually test tenant config, TOTP and Duo flows before wiring up Angular.</small></p>

  <!-- Tenant / user inputs -->
  <div>
    <label for="tenantId">Tenant ID</label>
    <input id="tenantId" type="text" value="demo-tenant" />

    <label for="email">User Email / Username</label>
    <input id="email" type="email" value="user@example.com" />
  </div>

  <hr />

  <!-- 1. Check tenant config -->
  <h2>1. Load Tenant Config</h2>
  <button class="btn-secondary btn-block" onclick="loadTenantConfig()">Load Config</button>
  <div id="tenantStatus" class="status"></div>

  <!-- 2. TOTP MFA flow -->
  <h2>2. Test TOTP MFA</h2>
  <button class="btn-primary btn-block" onclick="setupMfa()">Setup TOTP MFA</button>
  <div id="mfaSetupStatus" class="status"></div>
  <div id="totpSection" style="display:none;">
    <div class="qr" id="qrContainer"></div>
    <div>
      <label>Secret (manual entry)</label>
      <input id="totpSecret" type="text" readonly />
    </div>
    <div>
      <label for="totpCode">Enter code from authenticator</label>
      <input id="totpCode" type="text" maxlength="6" />
      <button class="btn-primary btn-block" onclick="verifyTotp()">Verify TOTP</button>
    </div>
  </div>

  <!-- 3. Duo Universal Prompt flow -->
  <h2>3. Test Duo MFA</h2>
  <p><small>This will redirect you to Duo; on success, Duo will return to the backend callback which then redirects back with a token.</small></p>
  <button class="btn-primary btn-block" onclick="startDuo()">Start Duo MFA</button>
  <div id="duoStatus" class="status"></div>

  <!-- 4. JWT result -->
  <h2>4. JWT From Backend</h2>
  <div id="jwtStatus" class="status"></div>
  <div id="jwtBox" class="token-box"></div>
</div>

<script>
  // CHANGE THIS: base URL of your API
  const API_BASE = 'https://localhost:5001/api'; // e.g. https://your-api-url.com/api

  // helper: get query param (for auth-success redirect handler)
  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  // 0. Handle auth-success redirect (for Duo callback redirect)
  (function handleAuthSuccess() {
    const token = getQueryParam('token');
    const email = getQueryParam('email');
    const tenantId = getQueryParam('tenantId');

    if (token) {
      document.getElementById('jwtStatus').textContent = 'Token received from backend (Duo / MFA success).';
      document.getElementById('jwtStatus').className = 'status ok';
      document.getElementById('jwtBox').textContent = token;

      if (email) document.getElementById('email').value = email;
      if (tenantId) document.getElementById('tenantId').value = tenantId;

      // optionally clean up query string
      if (window.history && window.history.replaceState) {
        const url = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, url);
      }
    }
  })();

  async function loadTenantConfig() {
    const tenantId = document.getElementById('tenantId').value.trim();
    const status = document.getElementById('tenantStatus');
    status.textContent = 'Loading...';
    status.className = 'status';

    try {
      const res = await fetch(`${API_BASE}/auth/tenant-config/${encodeURIComponent(tenantId)}`);
      if (!res.ok) {
        status.textContent = `Failed to load config (HTTP ${res.status})`;
        status.className = 'status error';
        return;
      }
      const cfg = await res.json();
      status.textContent =
        `Loaded. SSO: ${cfg.ssoEnabled}, MFA: ${cfg.mfaEnabled}, MFA provider: ${cfg.mfaProvider || 'n/a'}, Duo enabled: ${cfg.duoEnabled}`;
      status.className = 'status ok';
    } catch (e) {
      status.textContent = 'Error loading tenant config: ' + e;
      status.className = 'status error';
    }
  }

  async function setupMfa() {
    const tenantId = document.getElementById('tenantId').value.trim();
    const email = document.getElementById('email').value.trim();
    const status = document.getElementById('mfaSetupStatus');
    const totpSection = document.getElementById('totpSection');
    const qrContainer = document.getElementById('qrContainer');
    const totpSecretInput = document.getElementById('totpSecret');

    status.textContent = 'Calling /auth/mfa/setup...';
    status.className = 'status';
    totpSection.style.display = 'none';
    qrContainer.innerHTML = '';
    totpSecretInput.value = '';

    try {
      const res = await fetch(`${API_BASE}/auth/mfa/setup`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, tenantId })
      });
      if (!res.ok) {
        status.textContent = `MFA setup failed (HTTP ${res.status})`;
        status.className = 'status error';
        return;
      }
      const data = await res.json();

      status.textContent = `MFA setup OK. TOTP: ${!!data.totpAvailable}, Duo: ${!!data.duoAvailable}`;
      status.className = 'status ok';

      if (data.totpAvailable) {
        totpSecretInput.value = data.totpSecret || '';
        // Use backend-generated QR if present
        if (data.totpQrCodeBase64) {
          qrContainer.innerHTML =
            `<img src="data:image/png;base64,${data.totpQrCodeBase64}" alt="TOTP QR" />`;
        } else if (data.totpQrCodeUrl) {
          // or generate from otpauth URL via external QR service (dev only)
          const url = encodeURIComponent(data.totpQrCodeUrl);
          qrContainer.innerHTML =
            `<img src="https://api.qrserver.com/v1/create-qr-code/?data=${url}&size=200x200" alt="TOTP QR" />`;
        }
        totpSection.style.display = 'block';
      }
    } catch (e) {
      status.textContent = 'MFA setup error: ' + e;
      status.className = 'status error';
    }
  }

  async function verifyTotp() {
    const tenantId = document.getElementById('tenantId').value.trim();
    const email = document.getElementById('email').value.trim();
    const secret = document.getElementById('totpSecret').value.trim();
    const code = document.getElementById('totpCode').value.trim();
    const status = document.getElementById('jwtStatus');
    const jwtBox = document.getElementById('jwtBox');

    if (!code || !secret) {
      alert('Secret or code missing.');
      return;
    }

    status.textContent = 'Verifying TOTP...';
    status.className = 'status';

    try {
      // userId is test-only; in a real flow youâ€™d use the logged-in userId from your DB
      const userId = 1;
      const res = await fetch(`${API_BASE}/auth/mfa/verify-totp`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId,
          tenantId,
          email,
          name: email,
          secret,
          code
        })
      });

      if (!res.ok) {
        status.textContent = `TOTP verification failed (HTTP ${res.status})`;
        status.className = 'status error';
        return;
      }

      const data = await res.json();
      if (data.success) {
        status.textContent = 'TOTP verified; JWT issued.';
        status.className = 'status ok';
        jwtBox.textContent = data.token || '';
      } else {
        status.textContent = 'TOTP verification failed.';
        status.className = 'status error';
      }
    } catch (e) {
      status.textContent = 'TOTP verification error: ' + e;
      status.className = 'status error';
    }
  }

  async function startDuo() {
    const tenantId = document.getElementById('tenantId').value.trim();
    const email = document.getElementById('email').value.trim();
    const status = document.getElementById('duoStatus');

    status.textContent = 'Calling /auth/mfa/initiate-duo...';
    status.className = 'status';

    try {
      const res = await fetch(`${API_BASE}/auth/mfa/initiate-duo`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: email, tenantId })
      });
      if (!res.ok) {
        status.textContent = `Failed to initiate Duo (HTTP ${res.status})`;
        status.className = 'status error';
        return;
      }
      const data = await res.json();
      status.textContent = 'Redirecting to Duo...';
      status.className = 'status ok';

      // Redirect browser to Duo Universal Prompt
      window.location.href = data.authUrl;
    } catch (e) {
      status.textContent = 'Duo initiation error: ' + e;
      status.className = 'status error';
    }
  }
</script>
</body>
</html>
